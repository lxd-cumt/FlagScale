#  Install FlagScale

Clone FlagScale code from github.

```sh
git clone https://github.com/FlagOpen/FlagScale.git
cd FlagScale/
```

If you don't have access to the international internet, import FlagScale project on [gitee](https://gitee.com/), then clone from gitee.

```sh
git clone https://gitee.com/flagopen/FlagScale.git
cd FlagScale/
```

Install train and inference env according to [README](https://github.com/FlagOpen/FlagScale/blob/main/README.md) 

Install transformers(v4.53.0). Higher version will cause problem on image pre-processing.

```sh
pip install transformers==4.53.0
```

# Download Model

```sh
git lfs install

mkdir -p /models/BAAI/
cd /models/BAAI/
git clone https://huggingface.co/BAAI/RoboBrain-X0-Preview
```

If you don't have access to the international internet, download from modelscope.

```sh
mkdir -p /models/
cd /models/
modelscope download --model BAAI/RoboBrain-X0-Preview --local_dir BAAI/RoboBrain-X0-Preview
```

# Serving

## Download Tokenzier

```sh
mkdir -p /models/physical-intelligence/
cd /models/physical-intelligence/
git lfs install
git clone https://huggingface.co/physical-intelligence/fast
```

## Edit Config

```sh
cd FlagScale/
vim examples/robobrain_x0/conf/serve/robobrain_x0.yaml
```

Change 3 fields:
- engine_args.model_sub_task -> /models/BAAI/RoboBrain-X0-Preview
- engine_args.port -> A port available in your env, for example: 5001
- engine_args.tokenizer_path ->/models/physical-intelligence/fast

## Run Serving

```sh
cd FlagScale/
python run.py --config-path ./examples/robobrain_x0/conf --config-name serve action=run
```

## Test Server with Client

Download test images:

```sh
cd FlagScale/
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_0_latest.jpg
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_1_latest.jpg
wget https://gitee.com/hchnr/flag-scale/blob/robotics_dataset/orbbec_2_latest.jpg
```

Run client:

```sh
python examples/robobrain_x0/client_agilex.py  \
--host 127.0.0.1 \
--port 5001 \
--base-img orbbec_0_latest.jpg \
--left-wrist-img orbbec_1_latest.jpg \
--right-wrist-img orbbec_2_latest.jpg \
--num-steps 20
```

# Training

## Prepare Dataset

FlagScale uses WebDataset format and Megatraon.Energon data loader, you need process your data first.

For example, there is a dataset of 2 timesteps: [demo_0913_n2](https://gitee.com/hchnr/flag-scale/tree/robotics_dataset/demo_0913_n2/wds-256).

Download demo_0913_n2:

```sh
git archive --remote=git@gitee.com:hchnr/flag-scale.git robotics_dataset demo_0913_n2/ | tar -xv -C .
```

The directory structure of demo_0913_n2 is as follows:
- build_dep.sh: Copy .npy and .jpg files from production environment to ./deps
- demo_0913_n2.jsonl: Timesteps, including: task(str), images(.jpg), action(.npy), state(.npy)
- deps: .npy and .jpg files
- wds-256: Data in webdataset format (DP=256), generated by tools/datasets/vla/convert.py

Generate Data in webdataset format (DP=2) to ./demo_0913_n2/wds-2:

```sh
python tools/datasets/vla/convert.py \
    --dataset-root=./demo_0913_n2 \
    --output-root=./demo_0913_n2 \
    --json=demo_0913_n2.jsonl \
    --train-split 1 \
    --val-split 0 \
    --images-key=image \
    --videos-key=video \
    --vision-root='' \
    --shuffle-tars \
    --num-workers=1 \
    --max-samples-per-tar 100000 \
    --dp-size 2
```

Move .jpg and .npy files from ./demo_0913_n2/deps to /:

```sh
mkdir -p /share/
cp -r ./demo_0913_n2/deps/* /
```

## Edit Config

```sh
cd FlagScale/
vim examples/robobrain_x0/conf/train/robobrain_x0.yaml
```
Change 2 fields:
- data.data_path -> xxx/demo_0913_n2/wds-256
- data.tokenizer -> /models/BAAI/RoboBrain-X0-Preview

## Start Training
```sh
cd FlagScale/
python run.py --config-path ./examples/robobrain_x0/conf/ --config-name train action=run
```
